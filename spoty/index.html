<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Lecteur Spotify Playlists</title>
  <script src="https://sdk.scdn.co/spotify-player.js"></script>
  <style>
    body { font-family: Arial, sans-serif; }
    button { margin: 5px; padding: 8px 12px; cursor: pointer; }
    .playlist { margin: 10px 0; }
  </style>
</head>
<body>
  <h1>ðŸŽµ Mes Playlists Spotify</h1>
  <button id="connect">Se connecter Ã  Spotify</button>
  <div id="status"></div>
  <div id="playlists"></div>

  <script>
    const client_id = "b6cdc02492a84d34b9f75cadcca4f498"; // ton client ID
    const redirect_uri = "https://pittermanifique.github.io/callback.html";
    const scopes = "streaming user-read-email user-read-private playlist-read-private playlist-read-collaborative";

    let player, token;

    // Bouton connexion
    document.getElementById("connect").onclick = () => {
      const url = `https://accounts.spotify.com/authorize?client_id=${client_id}&response_type=token&redirect_uri=${encodeURIComponent(redirect_uri)}&scope=${encodeURIComponent(scopes)}`;
      window.location = url;
    };

    // RÃ©cupÃ©rer token depuis localStorage
    const storedHash = localStorage.getItem("spotify_token");
    if (storedHash) {
      token = storedHash.split("&")[0].split("=")[1];
    }

    if (token) {
      document.getElementById("status").innerText = "âœ… ConnectÃ© Ã  Spotify";

      // Initialisation du Web Playback SDK
      window.onSpotifyWebPlaybackSDKReady = () => {
        player = new Spotify.Player({
          name: 'Lecteur Web',
          getOAuthToken: cb => { cb(token); },
          volume: 0.5
        });

        player.addListener('ready', ({ device_id }) => {
          console.log('Device prÃªt', device_id);
          document.getElementById("status").innerText = "ðŸŽ¶ Lecteur prÃªt !";

          // Une fois prÃªt, rÃ©cupÃ©rer et afficher les playlists
          loadPlaylists(device_id);
        });

        player.connect();
      };
    }

    async function loadPlaylists(device_id) {
      const res = await fetch("https://api.spotify.com/v1/me/playlists?limit=50", {
        headers: { Authorization: `Bearer ${token}` }
      });
      const data = await res.json();
      const container = document.getElementById("playlists");
      container.innerHTML = "";

      data.items.forEach(pl => {
        const btn = document.createElement("button");
        btn.textContent = pl.name + ` (${pl.tracks.total} titres)`;
        btn.className = "playlist";
        btn.onclick = () => playPlaylist(pl.uri, device_id);
        container.appendChild(btn);
      });
    }

    async function playPlaylist(playlistUri, device_id) {
      await fetch(`https://api.spotify.com/v1/me/player/play?device_id=${device_id}`, {
        method: "PUT",
        headers: { Authorization: `Bearer ${token}` },
        body: JSON.stringify({ context_uri: playlistUri })
      });
      console.log("ðŸŽµ Lecture de la playlist :", playlistUri);
    }
  </script>
</body>
</html>
